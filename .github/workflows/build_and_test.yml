name: Build & Test
on:
    pull_request:
      branches: [main]
    push:
      branches: [main]

jobs:
    build:
        name: Build & Test
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4
            - uses: DeterminateSystems/nix-installer-action@main
            - uses: DeterminateSystems/magic-nix-cache-action@main
            - uses: DeterminateSystems/flake-checker-action@main
            - uses: cachix/cachix-action@v14
              with:
                name: nix-community

            - name: Lint Rust
              run: |
                cd inference
                nix develop --command cargo fmt -- --check
                nix develop --command cargo clippy --all-targets --all-features -- -D warnings
                cd -

            - name: Lint TypeScript
              run: |
                nix develop --command pnpm run lint

            - name: Build project
              run: nix build .

            - name: Test project
              run: nix flake check

            - name: Temporary check
              run: ls -al
